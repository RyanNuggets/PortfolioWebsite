<!-- admin-board.html (FULL FILE) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Board – Nugget Studios</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body class="page-layout">
  <!-- NAVBAR -->
  <nav class="navbar fade-in">
    <div class="nav-inner">
      <a href="/" class="nav-home">
        <img src="images/logo2.png" alt="Navbar Logo" class="nav-logo">
      </a>

      <span class="divider"></span>
      <a href="/about" class="nav-link">About</a>

      <span class="divider"></span>
      <a href="/clients" class="nav-link">Clients</a>

      <span class="divider"></span>
      <a href="/past-work" class="nav-link">Past Work</a>

      <span class="divider"></span>
      <a href="/contact" class="nav-link">Contact</a>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="page-content fade-in">
    <section class="board-page">
      <div class="board-shell">
        <h1 class="board-title">Editor Panel</h1>
        <p class="board-sub">Drag cards to change status • Delivered → Archive to hide from clients</p>

        <!-- add order -->
        <div class="admin-add">
          <div class="admin-row">
            <input id="title" class="admin-input" placeholder="Order title (e.g. Discord Banner)" />
            <input id="client" class="admin-input" placeholder="Client / Server name" />
          </div>
          <textarea id="notes" class="admin-textarea" placeholder="Notes (optional)"></textarea>
          <button class="admin-btn" id="addBtn" type="button">Add Order</button>
          <div class="admin-hint" id="adminHint"></div>
        </div>

        <div class="board" id="board" aria-label="Admin order board"></div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer-strip">
    <div class="footer-divider"></div>
    <div class="footer-inner">
      <img src="images/logo2.png" class="footer-logo" alt="Footer Logo">
      <p class="footer-text">Copyright © 2026 Nugget Studios. All rights reserved.</p>
    </div>
  </footer>

  <script>
    // ✅ Admin sees Archived column too
    const STATUSES = ["Queued", "In Progress", "Review", "Delivered", "Archived"];
    const board = document.getElementById("board");

    const titleEl = document.getElementById("title");
    const clientEl = document.getElementById("client");
    const notesEl = document.getElementById("notes");
    const addBtn = document.getElementById("addBtn");
    const adminHint = document.getElementById("adminHint");

    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));

    function groupByStatus(items) {
      const map = {};
      STATUSES.forEach(s => (map[s] = []));
      items.forEach(o => {
        if (map[o.status]) map[o.status].push(o);
        else map["Queued"].push(o);
      });
      return map;
    }

    async function apiGet() {
      const res = await fetch("/api/orders", { cache: "no-store" });
      return res.json();
    }

    async function apiAdd(payload) {
      const res = await fetch("/api/orders", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    async function apiPatch(id, body) {
      const res = await fetch(`/api/orders/${encodeURIComponent(id)}`, {
        method: "PATCH",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      return res.json();
    }

    function renderBoard(items) {
      const grouped = groupByStatus(items);

      board.innerHTML = STATUSES.map((status) => {
        const cards = grouped[status].map((o) => `
          <article class="order-card is-draggable" draggable="true" data-id="${esc(o.id)}">
            <div class="order-top">
              <div class="order-title">${esc(o.title)}</div>
              <div class="order-badge">${esc(o.status)}</div>
            </div>

            <div class="order-meta">
              <div class="order-line"><span>Client:</span> ${esc(o.client)}</div>
              <div class="order-line"><span>Updated:</span> ${esc(o.updatedAt || "—")}</div>
            </div>

            <p class="order-notes">${esc(o.notes || "")}</p>

            ${o.status === "Delivered" ? `
              <button class="order-archive" type="button" data-archive="${esc(o.id)}">Archive</button>
            ` : ""}
          </article>
        `).join("");

        return `
          <section class="col" data-status="${esc(status)}">
            <div class="col-head">
              <div class="col-title">${esc(status)}</div>
              <div class="col-sub">${grouped[status].length} orders</div>
            </div>

            <div class="col-body dropzone" data-status="${esc(status)}">
              ${cards || `<div class="col-empty">Drop orders here.</div>`}
            </div>
          </section>
        `;
      }).join("");

      wireDnD();
      wireArchiveButtons();
    }

    function wireDnD() {
      const cards = document.querySelectorAll(".order-card.is-draggable");
      const zones = document.querySelectorAll(".dropzone");

      cards.forEach((card) => {
        card.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", card.dataset.id);
          card.classList.add("dragging");
        });
        card.addEventListener("dragend", () => card.classList.remove("dragging"));
      });

      zones.forEach((zone) => {
        zone.addEventListener("dragover", (e) => {
          e.preventDefault();
          zone.classList.add("drop-over");
        });
        zone.addEventListener("dragleave", () => zone.classList.remove("drop-over"));

        zone.addEventListener("drop", async (e) => {
          e.preventDefault();
          zone.classList.remove("drop-over");

          const id = e.dataTransfer.getData("text/plain");
          const newStatus = zone.dataset.status;
          if (!id || !newStatus) return;

          await apiPatch(id, { status: newStatus });
          await loadOrders();
        });
      });
    }

    function wireArchiveButtons() {
      document.querySelectorAll("[data-archive]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-archive");
          await apiPatch(id, { status: "Archived" });
          await loadOrders();
        });
      });
    }

    async function loadOrders() {
      const data = await apiGet();
      renderBoard(data.items || []);
    }

    addBtn.addEventListener("click", async () => {
      adminHint.textContent = "";
      const title = (titleEl.value || "").trim();
      const client = (clientEl.value || "").trim();
      const notes = (notesEl.value || "").trim();

      if (!title || !client) {
        adminHint.textContent = "Title and Client are required.";
        return;
      }

      await apiAdd({ title, client, notes, status: "Queued" });

      titleEl.value = "";
      clientEl.value = "";
      notesEl.value = "";

      await loadOrders();
    });

    loadOrders();
    setInterval(loadOrders, 4000);
  </script>
</body>
</html>
