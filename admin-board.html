<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Board – Nugget Studios</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="page-layout">
  <!-- NAVBAR -->
  <nav class="navbar fade-in">
    <div class="nav-inner">
      <a href="/" class="nav-home">
        <img src="images/logo2.png" alt="Navbar Logo" class="nav-logo">
      </a>

      <span class="divider"></span>
      <a href="/about" class="nav-link">About</a>

      <span class="divider"></span>
      <a href="/clients" class="nav-link">Clients</a>

      <span class="divider"></span>
      <a href="/past-work" class="nav-link">Past Work</a>

      <span class="divider"></span>
      <a href="/contact" class="nav-link">Contact</a>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="page-content fade-in">
    <section class="board">
      <div class="board-shell">
        <div class="board-head" style="justify-content:center; flex-direction:column; text-align:center;">
          <div>
            <h1 class="board-title" style="margin:0 0 10px;">Editor Panel</h1>
            <p class="board-sub" style="margin:0;">Drag orders between columns, or archive delivered orders.</p>
          </div>
        </div>

        <!-- Add order -->
        <div class="admin-add">
          <form class="admin-add-form" id="addForm">
            <input id="title" placeholder="Order title" required />
            <input id="client" placeholder="Client name" required />
            <select id="status">
              <option>Queued</option>
              <option>In Progress</option>
              <option>Review</option>
              <option>Delivered</option>
              <option>Archived</option>
            </select>
            <button class="board-btn is-primary" type="submit">Add</button>
          </form>
          <div class="board-msg" id="msg" aria-live="polite"></div>
        </div>

        <div id="board" style="margin-top:18px;"></div>

        <p class="board-mini" style="text-align:center;">
          Tip: use “Archive” on Delivered → it moves to Archived (stays saved).
        </p>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer-strip">
    <div class="footer-divider"></div>
    <div class="footer-inner">
      <img src="images/logo2.png" class="footer-logo" alt="Footer Logo">
      <p class="footer-text">Copyright © 2026 Nugget Studios. All rights reserved.</p>
    </div>
  </footer>

  <script>
    // --- CONFIG (admin DOES show Archived) ---
    const STATUSES = ["Queued", "In Progress", "Review", "Delivered", "Archived"];

    // --- ELEMENTS ---
    const board = document.getElementById("board");
    const addForm = document.getElementById("addForm");
    const msg = document.getElementById("msg");

    const titleEl = document.getElementById("title");
    const clientEl = document.getElementById("client");
    const statusEl = document.getElementById("status");

    // --- HELPERS ---
    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));

    function nowStamp() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function groupByStatus(items) {
      const map = {};
      STATUSES.forEach(s => (map[s] = []));
      items.forEach(o => {
        if (map[o.status]) map[o.status].push(o);
        else map["Queued"].push(o);
      });
      return map;
    }

    async function apiUpdateStatus(id, newStatus) {
      await fetch(`/api/orders/${encodeURIComponent(id)}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus, updatedAt: nowStamp() })
      });
    }

    async function apiArchive(id) {
      return apiUpdateStatus(id, "Archived");
    }

    async function apiAdd(payload) {
      const res = await fetch("/api/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      return res.json();
    }

    // --- RENDER (OLD STYLE) ---
    function renderBoard(items) {
      const grouped = groupByStatus(items);

      board.innerHTML = `
        <div class="kanban">
          ${STATUSES.map((status) => {
            const cards = grouped[status].map((o) => `
              <article class="order-card is-draggable" draggable="true" data-id="${esc(o.id)}">
                <div class="order-top">
                  <div class="order-title">${esc(o.title)}</div>
                  <div class="order-badge">${esc(o.status)}</div>
                </div>

                <div class="order-meta">
                  <div class="order-line"><span>Client:</span> ${esc(o.client)}</div>
                  <div class="order-line"><span>Updated:</span> ${esc(o.updatedAt || "—")}</div>
                </div>

                <p class="order-notes">${esc(o.notes || "")}</p>

                <!-- ✅ quick archive button (only show when Delivered) -->
                ${o.status === "Delivered" ? `
                  <button class="order-archive" type="button" data-archive="${esc(o.id)}">
                    Archive
                  </button>
                ` : ""}
              </article>
            `).join("");

            return `
              <section class="col" data-status="${esc(status)}">
                <div class="col-head">
                  <div class="col-title">${esc(status)}</div>
                  <div class="col-sub">${grouped[status].length} orders</div>
                </div>

                <div class="col-body dropzone" data-status="${esc(status)}">
                  ${cards || `<div class="col-empty">Drop orders here.</div>`}
                </div>
              </section>
            `;
          }).join("")}
        </div>
      `;

      wireDnD();
      wireArchiveButtons();
    }

    // --- DRAG & DROP ---
    function wireDnD() {
      const cards = document.querySelectorAll(".order-card.is-draggable");
      const zones = document.querySelectorAll(".dropzone");

      cards.forEach((card) => {
        card.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", card.dataset.id);
          card.classList.add("dragging");
        });
        card.addEventListener("dragend", () => card.classList.remove("dragging"));
      });

      zones.forEach((zone) => {
        zone.addEventListener("dragover", (e) => {
          e.preventDefault();
          zone.classList.add("drop-over");
        });

        zone.addEventListener("dragleave", () => zone.classList.remove("drop-over"));

        zone.addEventListener("drop", async (e) => {
          e.preventDefault();
          zone.classList.remove("drop-over");

          const id = e.dataTransfer.getData("text/plain");
          const newStatus = zone.dataset.status;

          if (!id || !newStatus) return;

          await apiUpdateStatus(id, newStatus);
          await loadOrders();
        });
      });
    }

    // --- ARCHIVE BUTTON ---
    function wireArchiveButtons() {
      document.querySelectorAll("[data-archive]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-archive");
          await apiArchive(id);
          await loadOrders();
        });
      });
    }

    // --- LOAD (admin) ---
    async function loadOrders() {
      const res = await fetch("/api/orders");
      const data = await res.json();
      renderBoard(data.items || []);
    }

    loadOrders();

    // --- ADD FORM ---
    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";
      msg.className = "board-msg";

      const payload = {
        title: titleEl.value.trim(),
        client: clientEl.value.trim(),
        status: statusEl.value,
        notes: "",
        updatedAt: nowStamp()
      };

      if (!payload.title || !payload.client) {
        msg.textContent = "Title + client required.";
        msg.classList.add("is-err");
        return;
      }

      const out = await apiAdd(payload);
      if (!out.ok) {
        msg.textContent = out.error || "Failed to add order.";
        msg.classList.add("is-err");
        return;
      }

      titleEl.value = "";
      clientEl.value = "";
      statusEl.value = "Queued";

      msg.textContent = "Order added.";
      msg.classList.add("is-ok");

      await loadOrders();
    });
  </script>
</body>
</html>
